<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Assistant</title>
</head>
<body>
  <h1>Chat Assistant</h1>
  <label for="fleet_id">Select Fleet ID:</label>
  <select id="fleet_id">
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
  <br><br>
  <label for="query">Enter Query:</label>
  <input type="text" id="query" placeholder="Enter your query here">
  <button id="submit">Submit</button>
  <pre id="response"></pre>

  <script>
    document.getElementById('submit').addEventListener('click', async () => {
      const fleetId = document.getElementById('fleet_id').value;
      const query = document.getElementById('query').value;

      const backendUrl = 'https://genai-sql-1.onrender.com'; // 'http://localhost:8000/chat/execute_user_query'
      const user = 'end_user'; // superuser

      try {
        // Request JWT Token from Backend
        const tokenResponse = await fetch(`${backendUrl}/auth/generate_jwt_token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sub: user, fleet_id: fleetId })
        });

        if (!tokenResponse.ok) {
          throw new Error('Failed to generate token');
        }

        const { token } = await tokenResponse.json();

        // Send Query to Backend with Token
        const chatResponse = await fetch(`${backendUrl}/chat/execute_user_query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ query, fleet_id: fleetId }) 
        });


    // try:
    //     print("generate_jwt_token endpoint!")
    //     payload = {
    //         "sub": sub,
    //         "fleet_id": fleet_id,
    //         "exp": datetime.utcnow() + timedelta(hours=exp_hours)
    //     }
    //     token = jwt.encode(payload, SECRET_KEY, algorithm="HS256")
    //     return token
    
    // except Exception as e:
    //     raise HTTPException(
    //         status_code=500,
    //         detail=f"Failed to generate token: {e}"
    //     )

// curl -X POST http://localhost:8000/chat/execute_user_query \
//   -H "Content-Type: application/json" \
//   -H "Authorization: Bearer $(cat api/scripts/token.txt)" \
//   -d '{"query":"How many SRM T3 EVs are in my fleet?"}'



        if (!chatResponse.ok) {
          throw new Error('Failed to fetch chat response');
        }
        if (!chatResponse.ok) {
          const errorDetails = await chatResponse.text();
          throw new Error(`Failed to fetch chat response. Status: ${chatResponse.status}, Details: ${errorDetails}`);
        }

        const responseData = await chatResponse.json();
        document.getElementById('response').textContent = JSON.stringify(responseData, null, 2);
      } catch (error) {
        document.getElementById('response').textContent = `Error: ${error.message}`;
      }
    });
  </script>
</body>
</html>


<!-- 'http://localhost:8000/chat/execute_user_query' -->